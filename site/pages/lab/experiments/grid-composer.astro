---
/**
 * Grid Composer — Lab Experiment
 *
 * Wireframe layout tool for placing semantic HTML elements
 * onto a CSS Grid canvas with live code output.
 */

import LabLayout from '../../../layouts/LabLayout.astro';
---

<LabLayout
  title="Grid Composer"
  description="CSS Grid layout composer for placing semantic blocks and generating clean HTML + CSS."
>
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <ol>
      <li><a href="/lab/">Lab</a></li>
      <li><a href="/lab/experiments/">Experiments</a></li>
      <li><span aria-current="page">Grid Composer</span></li>
    </ol>
  </nav>

  <vb-composer>
    <header class="composer-toolbar">
      <h1>Grid Composer</h1>
      <nav aria-label="Block palette" class="palette">
        <button type="button" data-action="add" data-tag="header">header</button>
        <button type="button" data-action="add" data-tag="nav">nav</button>
        <button type="button" data-action="add" data-tag="main">main</button>
        <button type="button" data-action="add" data-tag="aside">aside</button>
        <button type="button" data-action="add" data-tag="section">section</button>
        <button type="button" data-action="add" data-tag="article">article</button>
        <button type="button" data-action="add" data-tag="footer">footer</button>
      </nav>
      <label class="wf-toggle">
        <input type="checkbox" data-action="wireframe" checked />
        Wireframe
      </label>
      <label class="wf-toggle">
        <input type="checkbox" data-action="show-columns" />
        Columns
      </label>
      <fieldset class="grid-settings">
        <legend class="visually-hidden">Grid settings</legend>
        <label>Cols <input type="number" name="cols" value="12" min="1" max="24" /></label>
        <label>Gap <input type="text" name="gap" value="0.75rem" size="6" /></label>
        <label>Row <input type="text" name="row-size" value="3rem" size="5" /></label>
      </fieldset>
      <select data-action="load-template">
        <option value="">Template...</option>
        <option value="holy-grail">Holy Grail</option>
        <option value="blog">Blog</option>
        <option value="marketing">Marketing</option>
      </select>
    </header>

    <section class="composer-body">
      <vb-canvas data-wireframe>
        <header style="--col:1;--cspan:12;--row:1;--rspan:2;"></header>
        <nav style="--col:1;--cspan:2;--row:3;--rspan:6;"></nav>
        <main style="--col:3;--cspan:10;--row:3;--rspan:6;"></main>
        <footer style="--col:1;--cspan:12;--row:9;--rspan:2;"></footer>
      </vb-canvas>

      <vb-inspector aria-label="Block inspector">
        <h2>Inspector</h2>
        <p data-placeholder>Select a block to edit its properties.</p>
      </vb-inspector>
    </section>

    <section class="composer-output">
      <h2>Output</h2>
      <fieldset class="export-modes">
        <legend>Export mode</legend>
        <label><input type="radio" name="export-mode" value="vars" checked /> Placement vars</label>
        <label><input type="radio" name="export-mode" value="areas" /> Named areas</label>
      </fieldset>
      <section class="code-panels">
        <section>
          <h3>HTML</h3>
          <pre><code id="out-html"></code></pre>
        </section>
        <section>
          <h3>CSS</h3>
          <pre><code id="out-css"></code></pre>
        </section>
      </section>
    </section>

    <div aria-live="polite" class="visually-hidden"></div>
  </vb-composer>

  <script>
    import '/src/lib/composer/composer.js';
  </script>
</LabLayout>

<style>
  /* --- Composer app shell layout --- */

  vb-composer {
    display: block;
    max-inline-size: 1200px;
    margin-inline: auto;
  }

  .composer-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--size-s, 0.5rem);
    padding-block-end: var(--size-m, 1rem);
    border-block-end: 1px solid var(--color-border, #ddd);
    margin-block-end: var(--size-m, 1rem);
  }

  .composer-toolbar h1 {
    font-size: var(--font-size-l, 1.25rem);
    margin: 0;
    margin-inline-end: auto;
  }

  .palette {
    display: flex;
    flex-wrap: wrap;
    gap: var(--size-2xs, 0.25rem);
  }

  .palette button {
    font-size: var(--font-size-s, 0.8125rem);
    padding: var(--size-2xs, 0.25rem) var(--size-xs, 0.375rem);
    border-radius: var(--radius-s, 4px);
    border: 1px solid var(--color-border, #ccc);
    background: var(--color-surface, #fff);
    color: var(--color-text, #333);
    cursor: pointer;
    font-family: ui-monospace, monospace;
  }

  .palette button:hover {
    background: var(--color-primary, oklch(55% 0.22 260));
    color: white;
    border-color: transparent;
  }

  .wf-toggle {
    display: flex;
    align-items: center;
    gap: var(--size-2xs, 0.25rem);
    cursor: pointer;
    font-size: var(--font-size-s, 0.8125rem);
  }

  .grid-settings {
    display: flex;
    align-items: center;
    gap: var(--size-s, 0.5rem);
    border: 0;
    padding: 0;
    margin: 0;
    font-size: var(--font-size-s, 0.8125rem);
  }

  .grid-settings label {
    display: flex;
    align-items: center;
    gap: var(--size-2xs, 0.25rem);
    font-weight: 500;
  }

  .grid-settings input {
    padding: var(--size-2xs, 0.25rem);
    border: 1px solid var(--color-border, #ccc);
    border-radius: var(--radius-s, 4px);
    font-family: ui-monospace, monospace;
    font-size: var(--font-size-s, 0.8125rem);
    inline-size: 4rem;
  }

  .grid-settings input[type="number"] {
    inline-size: 3.5rem;
  }

  [data-action="load-template"] {
    padding: var(--size-2xs, 0.25rem) var(--size-xs, 0.375rem);
    border: 1px solid var(--color-border, #ccc);
    border-radius: var(--radius-s, 4px);
    font-size: var(--font-size-s, 0.8125rem);
    background: var(--color-surface, #fff);
    cursor: pointer;
  }

  /* --- Body: canvas + inspector side by side --- */

  .composer-body {
    display: grid;
    grid-template-columns: 1fr 220px;
    gap: var(--size-m, 1rem);
    margin-block-end: var(--size-m, 1rem);
  }

  @media (max-width: 700px) {
    .composer-body {
      grid-template-columns: 1fr;
    }
  }

  /* --- Canvas (content layer) --- */

  vb-canvas {
    --cols: 12;
    --gap: 0.75rem;
    --row-size: 3rem;
    --max-w: none;

    display: grid;
    grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
    grid-auto-rows: var(--row-size);
    gap: var(--gap);
    padding: var(--gap);
    border: 1px solid var(--color-border, #ddd);
    border-radius: var(--radius-m, 8px);
    background: var(--color-surface, #fff);
    position: relative;
    min-block-size: 30rem;
  }

  /* Block placement via CSS vars (canvas direct children + nested) */
  vb-canvas > :is(header, main, aside, footer, section, article, nav, figure, form),
  [data-subgrid] > :is(header, main, aside, footer, section, article, nav, figure, form) {
    grid-column: var(--col, 1) / span var(--cspan, 12);
    grid-row: var(--row, auto) / span var(--rspan, 2);
  }

  /* Subgrid: columns only */
  [data-subgrid] {
    display: grid;
    grid-template-columns: subgrid;
    grid-auto-rows: var(--row-size);
    gap: var(--gap);
  }

  @supports not (grid-template-columns: subgrid) {
    [data-subgrid] {
      grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
    }
  }

  /* --- Editor layer (wireframe mode) --- */

  vb-canvas[data-wireframe] > :is(header, main, aside, footer, section, article, nav, figure, form),
  vb-canvas[data-wireframe] [data-subgrid] > :is(header, main, aside, footer, section, article, nav, figure, form) {
    outline: 2px dashed currentColor;
    border-radius: var(--radius-s, 4px);
    min-block-size: calc(var(--row-size) * 2);
    position: relative;
    user-select: none;
    cursor: grab;

    &[data-selected] {
      outline-style: solid;
      outline-color: var(--color-primary, oklch(55% 0.22 260));
      outline-width: 3px;
    }

    &:focus-visible {
      outline-color: var(--color-primary, oklch(55% 0.22 260));
      outline-offset: 2px;
    }
  }

  /* Block label */
  vb-canvas[data-wireframe] [data-vb-label]::before {
    content: attr(data-vb-label);
    position: absolute;
    inset-block-start: 0.5rem;
    inset-inline-start: 0.5rem;
    font: 600 0.8125rem/1 ui-monospace, monospace;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-s, 4px);
    background: var(--color-text, #333);
    color: var(--color-surface, #fff);
    pointer-events: none;
  }

  /* Grid overlay (wireframe background lines) */
  vb-canvas[data-wireframe]::before {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    background:
      repeating-linear-gradient(
        90deg,
        color-mix(in oklch, currentColor 6%, transparent) 0 1px,
        transparent 1px calc(100% / var(--cols))
      );
    z-index: -1;
  }

  /* Column overlay (::after — independent of wireframe ::before) */
  vb-canvas[data-show-columns]::after {
    content: "";
    position: absolute;
    inset: var(--gap);
    pointer-events: none;
    z-index: -1;
    background: repeating-linear-gradient(
      90deg,
      color-mix(in oklch, var(--color-primary, oklch(55% 0.22 260)) 8%, transparent)
        0
        calc((100% - (var(--cols) - 1) * var(--gap)) / var(--cols)),
      transparent
        calc((100% - (var(--cols) - 1) * var(--gap)) / var(--cols))
        calc((100% - (var(--cols) - 1) * var(--gap)) / var(--cols) + var(--gap))
    );
  }

  /* Drop zone indicator */
  :global([data-drop-zone]) {
    outline-color: var(--color-success, oklch(55% 0.2 145)) !important;
    outline-style: solid !important;
    outline-width: 3px !important;
    outline-offset: -3px;
  }

  /* Without wireframe: plain blocks */
  vb-canvas:not([data-wireframe]) > :is(header, main, aside, footer, section, article, nav, figure, form),
  vb-canvas:not([data-wireframe]) [data-subgrid] > :is(header, main, aside, footer, section, article, nav, figure, form) {
    background: color-mix(in oklch, currentColor 5%, transparent);
    border-radius: var(--radius-s, 4px);
  }

  /* --- Resize handles (dynamic elements — :global needed) --- */

  vb-canvas[data-wireframe] :global(vb-block-handle) {
    position: absolute;
    display: block;
    inline-size: 14px;
    block-size: 14px;
    border-radius: 50%;
    background: var(--color-primary, oklch(55% 0.22 260));
    border: 2px solid var(--color-surface, #fff);
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 1;
  }

  [data-selected] :global(vb-block-handle),
  vb-canvas[data-wireframe] > :is(header, main, aside, footer, section, article, nav, figure, form):hover :global(vb-block-handle),
  vb-canvas[data-wireframe] [data-subgrid] > :is(header, main, aside, footer, section, article, nav, figure, form):hover :global(vb-block-handle) {
    opacity: 0.75;
  }

  :global(vb-block-handle[data-dir="e"]) {
    inset-inline-end: -7px;
    inset-block-start: 50%;
    translate: 0 -50%;
    cursor: ew-resize;
  }

  :global(vb-block-handle[data-dir="s"]) {
    inset-block-end: -7px;
    inset-inline-start: 50%;
    translate: -50% 0;
    cursor: ns-resize;
  }

  :global(vb-block-handle[data-dir="se"]) {
    inset-inline-end: -7px;
    inset-block-end: -7px;
    cursor: nwse-resize;
  }

  vb-canvas:not([data-wireframe]) :global(vb-block-handle) {
    display: none;
  }

  /* --- Inspector --- */

  vb-inspector {
    display: block;
    padding: var(--size-s, 0.5rem);
    border: 1px solid var(--color-border, #ddd);
    border-radius: var(--radius-m, 8px);
    background: var(--color-surface, #fff);
    align-self: start;
  }

  vb-inspector h2 {
    font-size: var(--font-size-m, 1rem);
    margin-block-end: var(--size-s, 0.5rem);
  }

  vb-inspector [data-placeholder] {
    color: var(--color-text-muted, #888);
    font-size: var(--font-size-s, 0.8125rem);
  }

  vb-inspector form {
    display: flex;
    flex-direction: column;
    gap: var(--size-xs, 0.375rem);
  }

  vb-inspector label {
    display: flex;
    flex-direction: column;
    gap: var(--size-3xs, 0.125rem);
    font-size: var(--font-size-s, 0.8125rem);
    font-weight: 500;
  }

  vb-inspector .checkbox-label {
    flex-direction: row;
    align-items: center;
    gap: var(--size-2xs, 0.25rem);
  }

  vb-inspector select,
  vb-inspector input[type="number"] {
    padding: var(--size-2xs, 0.25rem) var(--size-xs, 0.375rem);
    border: 1px solid var(--color-border, #ccc);
    border-radius: var(--radius-s, 4px);
    font-family: ui-monospace, monospace;
    font-size: var(--font-size-s, 0.8125rem);
  }

  vb-inspector .nest-info {
    font-size: var(--font-size-s, 0.8125rem);
    color: var(--color-text-muted, #888);
    margin-block-end: var(--size-xs, 0.375rem);
  }

  vb-inspector .nest-info code {
    font-family: ui-monospace, monospace;
    background: var(--color-background, #f5f5f5);
    padding: 0.125rem 0.25rem;
    border-radius: var(--radius-s, 4px);
  }

  vb-inspector [data-action="unnest"] {
    margin-block-start: var(--size-xs, 0.375rem);
    padding: var(--size-2xs, 0.25rem) var(--size-xs, 0.375rem);
    background: var(--color-surface, #fff);
    color: var(--color-text, #333);
    border: 1px solid var(--color-border, #ccc);
    border-radius: var(--radius-s, 4px);
    cursor: pointer;
    font-size: var(--font-size-s, 0.8125rem);
  }

  vb-inspector [data-action="delete"] {
    margin-block-start: var(--size-xs, 0.375rem);
    padding: var(--size-2xs, 0.25rem) var(--size-xs, 0.375rem);
    background: var(--color-danger, oklch(55% 0.2 25));
    color: white;
    border: 0;
    border-radius: var(--radius-s, 4px);
    cursor: pointer;
    font-size: var(--font-size-s, 0.8125rem);
  }

  /* --- Output panel --- */

  .composer-output {
    border: 1px solid var(--color-border, #ddd);
    border-radius: var(--radius-m, 8px);
    padding: var(--size-m, 1rem);
    background: var(--color-surface, #fff);
  }

  .composer-output h2 {
    font-size: var(--font-size-m, 1rem);
    margin-block-end: var(--size-s, 0.5rem);
  }

  .export-modes {
    display: flex;
    gap: var(--size-m, 1rem);
    align-items: center;
    border: 0;
    padding: 0;
    margin-block-end: var(--size-s, 0.5rem);
    font-size: var(--font-size-s, 0.8125rem);
  }

  .export-modes legend {
    font-weight: 600;
    margin-inline-end: var(--size-s, 0.5rem);
  }

  .export-modes label {
    display: flex;
    align-items: center;
    gap: var(--size-2xs, 0.25rem);
    cursor: pointer;
  }

  .code-panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--size-m, 1rem);
  }

  @media (max-width: 700px) {
    .code-panels {
      grid-template-columns: 1fr;
    }
  }

  .code-panels h3 {
    font-size: var(--font-size-s, 0.8125rem);
    margin-block-end: var(--size-2xs, 0.25rem);
  }

  .code-panels pre {
    background: var(--color-background, #f5f5f5);
    padding: var(--size-s, 0.5rem);
    border-radius: var(--radius-s, 4px);
    overflow-x: auto;
    font-size: var(--font-size-xs, 0.75rem);
    line-height: 1.5;
    max-block-size: 20rem;
  }

  /* --- Utility --- */

  .visually-hidden {
    position: absolute;
    inline-size: 1px;
    block-size: 1px;
    overflow: hidden;
    clip: rect(0 0 0 0);
    clip-path: inset(50%);
    white-space: nowrap;
  }
</style>
