---
/**
 * PageToc Component
 *
 * Generates a table of contents from the current page's headings.
 * Uses the page-toc web component for interactive features.
 *
 * Props:
 * - headings: Array of heading objects from Astro's getHeadings()
 * - label: Accessible label for the nav (optional)
 * - depth: Maximum heading depth to include (default: 3)
 */

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
  label?: string;
  depth?: number;
}

const {
  headings,
  label = 'On this page',
  depth = 3,
} = Astro.props;

// Filter headings to specified depth and skip h1
const filteredHeadings = headings.filter(
  (h) => h.depth > 1 && h.depth <= depth
);

// Group headings into a nested structure
function buildTocTree(headings: Heading[]) {
  const result: { heading: Heading; children: Heading[] }[] = [];
  let currentH2: { heading: Heading; children: Heading[] } | null = null;

  for (const heading of headings) {
    if (heading.depth === 2) {
      currentH2 = { heading, children: [] };
      result.push(currentH2);
    } else if (heading.depth === 3 && currentH2) {
      currentH2.children.push(heading);
    } else if (heading.depth === 3) {
      // H3 without parent H2
      result.push({ heading, children: [] });
    }
  }

  return result;
}

const tocTree = buildTocTree(filteredHeadings);
---

{filteredHeadings.length > 0 && (
  <page-toc>
    <nav class="toc" aria-label={label}>
      <h2 class="toc-title">{label}</h2>
      <ul>
        {tocTree.map(({ heading, children }) => (
          <li>
            <a href={`#${heading.slug}`}>{heading.text}</a>
            {children.length > 0 && (
              <ul>
                {children.map((child) => (
                  <li>
                    <a href={`#${child.slug}`}>{child.text}</a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))}
      </ul>
    </nav>
  </page-toc>
)}

<style>
  .toc {
    position: sticky;
    top: var(--size-l);
    max-height: calc(100vh - var(--size-2xl));
    overflow-y: auto;
    padding-inline-end: var(--size-m);
  }

  .toc-title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
    color: var(--color-text-muted);
    margin-block-end: var(--size-s);
  }

  .toc ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc li {
    margin-block: var(--size-2xs);
  }

  .toc li li {
    padding-inline-start: var(--size-m);
  }

  .toc a {
    display: block;
    padding-block: var(--size-2xs);
    color: var(--color-text-muted);
    text-decoration: none;
    font-size: var(--font-size-sm);
    line-height: var(--line-height-snug);
    border-inline-start: 2px solid transparent;
    padding-inline-start: var(--size-s);
    transition: color var(--duration-fast) var(--ease-out),
                border-color var(--duration-fast) var(--ease-out);
  }

  .toc a:hover {
    color: var(--color-text);
  }

  .toc a[aria-current="true"],
  .toc a.active {
    color: var(--color-primary);
    border-color: var(--color-primary);
  }
</style>
