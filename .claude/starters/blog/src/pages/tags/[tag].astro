---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => !data.draft);

  // Get all unique tags
  const tags = [...new Set(posts.flatMap((post) => post.data.tags))];

  return tags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter((post) => post.data.tags.includes(tag))
        .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()),
    },
  }));
}

const { tag, posts } = Astro.props;
---

<BaseLayout
  title={`Posts tagged "${tag}"`}
  description={`All posts tagged with "${tag}" on {{BLOG_NAME}}`}
>
  <div class="tag-page">
    <header class="page-header">
      <h1>
        <span class="tag-label">Tag:</span>
        {tag}
      </h1>
      <p>{posts.length} post{posts.length !== 1 ? 's' : ''}</p>
      <a href="/tags" class="back-link">&larr; All tags</a>
    </header>

    <div class="post-grid">
      {posts.map((post) => (
        <PostCard post={post} />
      ))}
    </div>
  </div>
</BaseLayout>